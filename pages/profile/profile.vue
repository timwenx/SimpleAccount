<template>
	<view class="container">
		<!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
		<view class="user-info">
			<view class="avatar-section">
				<image class="avatar" src="/static/logo.png" mode="aspectFit"></image>
				<text class="username">æˆ‘çš„è´¦æœ¬</text>
				<text class="user-desc">è®°å½•æ¯ä¸€ç¬”æ”¶æ”¯ï¼Œç®¡ç†ç¾å¥½ç”Ÿæ´»</text>
			</view>
		</view>
		
		<!-- AIåŠŸèƒ½ -->
		<view class="data-management">
			<text class="management-title">AIæ™ºèƒ½åŠŸèƒ½</text>
			<!-- <view class="management-item ai-chat-item" @click="goToChat">
				<view class="management-left">
					<text class="management-icon">ğŸ’¬</text>
					<text class="management-text">æ™ºèƒ½è®°è´¦èŠå¤©</text>
				</view>
				<text class="management-arrow">></text>
			</view> -->
			<view class="management-item ai-config-item" @click="goToAIConfig">
				<view class="management-left">
					<text class="management-icon">ğŸ¤–</text>
					<text class="management-text">æ™ºèƒ½ä½“é…ç½®</text>
				</view>
				<text class="management-arrow">></text>
			</view>
		</view>
		
		<!-- æ•°æ®ç®¡ç† -->
		<view class="data-management">
			<text class="management-title">æ•°æ®ç®¡ç†</text>
			<view class="management-item icon-manage-item" @click="goToIconManage">
				<view class="management-left">
					<text class="management-icon">ğŸ¨</text>
					<text class="management-text">å›¾æ ‡ç®¡ç†</text>
				</view>
				<text class="management-arrow">></text>
			</view>
			<view class="management-item refresh-item" @click="refreshCategories">
				<view class="management-left">
					<text class="management-icon">ğŸ”„</text>
					<text class="management-text">åˆ·æ–°åˆ†ç±»</text>
				</view>
				<text class="management-arrow">></text>
			</view>
			<view class="management-item import-item" @click="importData">
				<view class="management-left">
					<text class="management-icon">ğŸ“¥</text>
					<text class="management-text">å¯¼å…¥æ•°æ®</text>
				</view>
				<text class="management-arrow">></text>
			</view>
			<view class="management-item export-item" @click="exportData">
				<view class="management-left">
					<text class="management-icon">ğŸ“¤</text>
					<text class="management-text">å¯¼å‡ºæ•°æ®</text>
				</view>
				<text class="management-arrow">></text>
			</view>
			<view class="management-item danger-item" @click="clearAllData">
				<view class="management-left">
					<text class="management-icon">ğŸ—‘ï¸</text>
					<text class="management-text">æ¸…ç©ºæ‰€æœ‰è®°å½•</text>
				</view>
				<text class="management-arrow">></text>
			</view>
		</view>
		
		<!-- åº”ç”¨ä¿¡æ¯ -->
		<view class="app-info">
			<text class="info-title">å…³äºåº”ç”¨</text>
			<view class="info-item">
				<text class="info-label">ç‰ˆæœ¬å·ï¼š</text>
				<text class="info-value">1.0.0</text>
			</view>
			<view class="info-item">
				<text class="info-label">æ›´æ–°æ—¶é—´ï¼š</text>
				<text class="info-value">2025-09-02</text>
			</view>
		</view>
	</view>
</template>

<script>
	export default {
		data() {
			return {
				// ä»category.vueç§»è¿‡æ¥çš„é»˜è®¤åˆ†ç±»æ•°æ®
				defaultExpenseCategories: [
					{id: 1, name: 'é¤é¥®', icon: 'ğŸ½ï¸'},
					{id: 2, name: 'äº¤é€š', icon: 'ğŸš—'},
					{id: 3, name: 'è´­ç‰©', icon: 'ğŸ›ï¸'},
					{id: 4, name: 'å¨±ä¹', icon: 'ğŸ¬'},
					{id: 5, name: 'ä½æˆ¿', icon: 'ğŸ '},
					{id: 6, name: 'åŒ»ç–—', icon: 'ğŸ’Š'},
					{id: 7, name: 'æ•™è‚²', icon: 'ğŸ“š'},
					{id: 8, name: 'é€šè®¯', icon: 'ğŸ“±'},
					{id: 9, name: 'æœè£…', icon: 'ğŸ‘•'},
					{id: 10, name: 'å…¶ä»–', icon: 'ğŸ“¦'}
				],
				defaultIncomeCategories: [
					{id: 11, name: 'å·¥èµ„', icon: 'ğŸ’°'},
					{id: 12, name: 'å¥–é‡‘', icon: 'ğŸ'},
					{id: 13, name: 'æŠ•èµ„', icon: 'ğŸ“ˆ'},
					{id: 14, name: 'å…¼èŒ', icon: 'ğŸ’¼'},
					{id: 15, name: 'çº¢åŒ…', icon: 'ğŸ§§'},
					{id: 16, name: 'é€€æ¬¾', icon: 'â†©ï¸'},
					{id: 17, name: 'å…¶ä»–', icon: 'ğŸ’'}
				]
			}
		},
		
		methods: {
			// è·³è½¬åˆ°æ™ºèƒ½è®°è´¦èŠå¤©
			goToChat() {
				uni.navigateTo({
					url: '/pages/chat/chat'
				})
			},
			
			// è·³è½¬åˆ°AIé…ç½®é¡µé¢
			goToAIConfig() {
				uni.navigateTo({
					url: '/pages/ai-config/ai-config'
				})
			},
			
			goToIconManage() {
				// è·³è½¬åˆ°å›¾æ ‡ç®¡ç†é¡µé¢
				uni.navigateTo({
					url: '/pages/icon-manage/icon-manage'
				})
			},
			
			refreshCategories() {
				// åˆ·æ–°åˆ†ç±»æ•°æ® - é‡æ–°åŠ è½½é»˜è®¤åˆ†ç±»
				uni.setStorageSync('expenseCategories', [...this.defaultExpenseCategories])
				uni.setStorageSync('incomeCategories', [...this.defaultIncomeCategories])
				
				uni.showToast({
					title: 'åˆ†ç±»å·²åˆ·æ–°',
					icon: 'success',
					duration: 500
				})
			},
			
			clearAllData() {
				uni.showModal({
					title: 'ç¡®è®¤æ¸…ç©º',
					content: 'æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰è®°è´¦è®°å½•ï¼Œä¸”ä¸å¯æ¢å¤ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
					confirmColor: '#FF6B6B',
					success: (res) => {
						if (res.confirm) {
							uni.removeStorageSync('records')
							uni.showToast({
								title: 'æ•°æ®å·²æ¸…ç©º',
								icon: 'success'
							})
						}
					}
				})
			},
			
			importData() {
				// æ£€æŸ¥å¹³å°æ”¯æŒ
				// #ifdef APP-PLUS
				if (typeof plus === 'undefined') {
					uni.showToast({
						title: 'å½“å‰ç¯å¢ƒä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—®',
						icon: 'none'
					})
					return
				}
				
				uni.showActionSheet({
					itemList: ['ä»ä¸‹è½½ç›®å½•å¯¼å…¥', 'ä»æ–‡æ¡£ç›®å½•å¯¼å…¥', 'æ‰‹åŠ¨è¾“å…¥è·¯å¾„', 'ä»å‰ªåˆ‡æ¿å¯¼å…¥'],
					success: (res) => {
						if (res.tapIndex === 0) {
							this.selectFromDownloads()
						} else if (res.tapIndex === 1) {
							this.selectFromDocuments()
						} else if (res.tapIndex === 2) {
							this.manualInputPath()
						} else if (res.tapIndex === 3) {
							this.importFromClipboard()
						}
					}
				})
				// #endif
				
				// #ifndef APP-PLUS
				uni.showActionSheet({
					itemList: ['ä»å‰ªåˆ‡æ¿å¯¼å…¥'],
					success: (res) => {
						if (res.tapIndex === 0) {
							this.importFromClipboard()
						}
					}
				})
				// #endif
			},
			
			showCsvImportDialog() {
				console.log('=== æ˜¾ç¤ºCSVæ•°æ®è¾“å…¥å¯¹è¯æ¡† ===')
				// ä½¿ç”¨ prompt æ¥è·å–ç”¨æˆ·è¾“å…¥çš„CSVæ•°æ®
				uni.showModal({
					title: 'ç²˜è´´CSVæ•°æ®',
					content: 'è¯·å°†CSVæ•°æ®ç²˜è´´åˆ°ä¸‹æ–¹ï¼š\næ ¼å¼ï¼šæ—¶é—´,ç±»å‹,åˆ†ç±»,é‡‘é¢,å¤‡æ³¨\n\nç¤ºä¾‹ï¼š\n"2024-01-01 12:00","æ”¯å‡º","é¤é¥®","25.50","åˆé¤"',
					editable: true,
					placeholderText: 'è¯·ç²˜è´´CSVæ•°æ®...',
					confirmText: 'å¯¼å…¥',
					success: (res) => {
						console.log('CSVè¾“å…¥å¯¹è¯æ¡†ç»“æœ:', res)
						if (res.confirm && res.content && res.content.trim()) {
							console.log('ç”¨æˆ·è¾“å…¥CSVæ•°æ®é•¿åº¦:', res.content.trim().length)
							console.log('CSVæ•°æ®å†…å®¹é¢„è§ˆ:', res.content.trim().substring(0, 200) + (res.content.trim().length > 200 ? '...' : ''))
							this.parseCsvData(res.content.trim())
						} else if (res.confirm) {
							console.log('ç”¨æˆ·ç¡®è®¤ä½†æœªè¾“å…¥æ•°æ®')
							uni.showToast({
								title: 'è¯·è¾“å…¥æ•°æ®',
								icon: 'none'
							})
						} else {
							console.log('ç”¨æˆ·å–æ¶ˆCSVæ•°æ®è¾“å…¥')
						}
					}
				})
			},
			
			importFromClipboard() {
				console.log('=== å¼€å§‹ä»å‰ªåˆ‡æ¿å¯¼å…¥ ===')
				
				// #ifdef H5
				// æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨ç°ä»£Clipboard API
				if (navigator.clipboard && window.isSecureContext) {
					console.log('ä½¿ç”¨ç°ä»£Clipboard APIè¯»å–')
					navigator.clipboard.readText().then(clipboardData => {
						console.log('ç°ä»£Clipboard APIè¯»å–æˆåŠŸ')
						this.processClipboardData(clipboardData)
					}).catch(err => {
						console.error('ç°ä»£Clipboard APIè¯»å–å¤±è´¥:', err)
						this.showManualPasteDialog()
					})
				} else {
					console.log('ç°ä»£Clipboard APIä¸å¯ç”¨ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨ç²˜è´´å¯¹è¯æ¡†')
					this.showManualPasteDialog()
				}
				// #endif
				
				// #ifndef H5
				// éæµè§ˆå™¨ç¯å¢ƒä½¿ç”¨uni-app API
				uni.getClipboardData({
					success: (res) => {
						console.log('uni-appå‰ªåˆ‡æ¿è¯»å–æˆåŠŸ:', res)
						this.processClipboardData(res.data)
					},
					fail: (err) => {
						console.error('uni-appè¯»å–å‰ªåˆ‡æ¿å¤±è´¥:', err)
						uni.showModal({
							title: 'è¯»å–å¤±è´¥',
							content: 'æ— æ³•è¯»å–å‰ªåˆ‡æ¿å†…å®¹ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®æˆ–æ‰‹åŠ¨ç²˜è´´æ•°æ®ã€‚',
							showCancel: true,
							confirmText: 'æ‰‹åŠ¨è¾“å…¥',
							cancelText: 'å–æ¶ˆ',
							success: (modalRes) => {
								if (modalRes.confirm) {
									this.showCsvImportDialog()
								}
							}
						})
					}
				})
				// #endif
			},
			
			processClipboardData(clipboardData) {
				console.log('=== å¤„ç†å‰ªåˆ‡æ¿æ•°æ® ===')
				console.log('å‰ªåˆ‡æ¿æ•°æ®ç±»å‹:', typeof clipboardData)
				console.log('å‰ªåˆ‡æ¿æ•°æ®é•¿åº¦:', clipboardData ? clipboardData.length : 0)
				console.log('å‰ªåˆ‡æ¿æ•°æ®é¢„è§ˆ:', clipboardData ? clipboardData.substring(0, 200) + (clipboardData.length > 200 ? '...' : '') : 'æ— å†…å®¹')
				
				if (!clipboardData || !clipboardData.trim()) {
					uni.showModal({
						title: 'å‰ªåˆ‡æ¿ä¸ºç©º',
						content: 'å‰ªåˆ‡æ¿ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®ï¼Œè¯·å…ˆå¤åˆ¶CSVæ ¼å¼çš„æ•°æ®åˆ°å‰ªåˆ‡æ¿ã€‚\n\næ ¼å¼ï¼šæ—¶é—´,ç±»å‹,åˆ†ç±»,é‡‘é¢,å¤‡æ³¨',
						showCancel: false,
						confirmText: 'çŸ¥é“äº†'
					})
					return
				}
				
				// æ£€æŸ¥æ•°æ®æ ¼å¼
				const trimmedData = clipboardData.trim()
				if (!trimmedData.includes(',')) {
					uni.showModal({
						title: 'æ•°æ®æ ¼å¼é”™è¯¯',
						content: 'å‰ªåˆ‡æ¿ä¸­çš„æ•°æ®ä¸æ˜¯CSVæ ¼å¼ï¼Œè¯·ç¡®ä¿æ•°æ®åŒ…å«é€—å·åˆ†éš”çš„å­—æ®µã€‚\n\næ­£ç¡®æ ¼å¼ï¼š\næ—¶é—´,ç±»å‹,åˆ†ç±»,é‡‘é¢,å¤‡æ³¨',
						showCancel: false,
						confirmText: 'çŸ¥é“äº†'
					})
					return
				}
				
				// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
				const lines = trimmedData.split('\n').filter(line => line.trim())
				uni.showModal({
					title: 'ç¡®è®¤å¯¼å…¥',
					content: `æ£€æµ‹åˆ°å‰ªåˆ‡æ¿ä¸­æœ‰${lines.length}è¡Œæ•°æ®ï¼Œæ˜¯å¦å¯¼å…¥ï¼Ÿ\n\næ•°æ®é¢„è§ˆï¼š\n${trimmedData.substring(0, 100)}${trimmedData.length > 100 ? '...' : ''}`,
					confirmText: 'å¯¼å…¥',
					cancelText: 'å–æ¶ˆ',
					success: (modalRes) => {
						if (modalRes.confirm) {
							console.log('ç”¨æˆ·ç¡®è®¤å¯¼å…¥å‰ªåˆ‡æ¿æ•°æ®')
							this.parseCsvData(trimmedData)
						} else {
							console.log('ç”¨æˆ·å–æ¶ˆå¯¼å…¥å‰ªåˆ‡æ¿æ•°æ®')
						}
					}
				})
			},
			
			showManualPasteDialog() {
				console.log('=== æ˜¾ç¤ºæ‰‹åŠ¨ç²˜è´´å¯¹è¯æ¡† ===')
				uni.showModal({
					title: 'æ‰‹åŠ¨ç²˜è´´æ•°æ®',
					content: 'æ— æ³•è‡ªåŠ¨è¯»å–å‰ªåˆ‡æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´CSVæ•°æ®ã€‚ç‚¹å‡»ç¡®å®šåå°†æ˜¾ç¤ºè¾“å…¥æ¡†ã€‚\n\næ ¼å¼ï¼šæ—¶é—´,ç±»å‹,åˆ†ç±»,é‡‘é¢,å¤‡æ³¨',
					showCancel: true,
					confirmText: 'è¾“å…¥æ•°æ®',
					cancelText: 'å–æ¶ˆ',
					success: (res) => {
						if (res.confirm) {
							this.showCsvImportDialog()
						}
					}
				})
			},
			
			exportToClipboard(csvContent, recordCount) {
				console.log('=== å¼€å§‹å¯¼å‡ºåˆ°å‰ªåˆ‡æ¿ ===')
				console.log('è®°å½•æ•°é‡:', recordCount)
				console.log('CSVå†…å®¹é•¿åº¦:', csvContent.length)
				console.log('CSVå†…å®¹é¢„è§ˆ:', csvContent.substring(0, 200))
				
				// #ifdef H5
				// æµè§ˆå™¨ç¯å¢ƒä½¿ç”¨ç°ä»£Clipboard API
				if (navigator.clipboard && window.isSecureContext) {
					console.log('ä½¿ç”¨ç°ä»£Clipboard API')
					navigator.clipboard.writeText(csvContent).then(() => {
						console.log('ç°ä»£Clipboard APIå†™å…¥æˆåŠŸ')
						uni.showModal({
							title: 'å¯¼å‡ºæˆåŠŸ',
							content: `å·²å°†${recordCount}æ¡è®°å½•å¤åˆ¶åˆ°å‰ªåˆ‡æ¿\n\næ‚¨å¯ä»¥ç²˜è´´åˆ°ä»»æ„æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ä¿å­˜ä¸ºCSVæ–‡ä»¶ï¼Œæˆ–ç›´æ¥åœ¨å…¶ä»–åº”ç”¨ä¸­ä½¿ç”¨ã€‚`,
							showCancel: false,
							confirmText: 'çŸ¥é“äº†'
						})
					}).catch(err => {
						console.error('ç°ä»£Clipboard APIå¤±è´¥:', err)
						this.fallbackCopyToClipboard(csvContent, recordCount)
					})
				} else {
					console.log('ç°ä»£Clipboard APIä¸å¯ç”¨ï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ')
					this.fallbackCopyToClipboard(csvContent, recordCount)
				}
				// #endif
				
				// #ifndef H5
				// éæµè§ˆå™¨ç¯å¢ƒä½¿ç”¨uni-app API
				uni.setClipboardData({
					data: csvContent,
					success: () => {
						console.log('uni-appå‰ªåˆ‡æ¿å†™å…¥æˆåŠŸ')
						uni.showModal({
							title: 'å¯¼å‡ºæˆåŠŸ',
							content: `å·²å°†${recordCount}æ¡è®°å½•å¤åˆ¶åˆ°å‰ªåˆ‡æ¿\n\næ‚¨å¯ä»¥ç²˜è´´åˆ°ä»»æ„æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ä¿å­˜ä¸ºCSVæ–‡ä»¶ï¼Œæˆ–ç›´æ¥åœ¨å…¶ä»–åº”ç”¨ä¸­ä½¿ç”¨ã€‚`,
							showCancel: false,
							confirmText: 'çŸ¥é“äº†'
						})
					},
					fail: (err) => {
						console.error('uni-appå‰ªåˆ‡æ¿å†™å…¥å¤±è´¥:', err)
						uni.showModal({
							title: 'å¯¼å‡ºå¤±è´¥',
							content: 'æ— æ³•å°†æ•°æ®å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®ã€‚\n\næ‚¨å¯ä»¥å°è¯•å…¶ä»–å¯¼å‡ºæ–¹å¼ã€‚',
							showCancel: false,
							confirmText: 'çŸ¥é“äº†'
						})
					}
				})
				// #endif
			},
			
			fallbackCopyToClipboard(csvContent, recordCount) {
				console.log('=== ä½¿ç”¨åå¤‡å‰ªåˆ‡æ¿æ–¹æ¡ˆ ===')
				try {
					// åˆ›å»ºä¸´æ—¶textareaå…ƒç´ 
					const textArea = document.createElement('textarea')
					textArea.value = csvContent
					textArea.style.position = 'fixed'
					textArea.style.left = '-999999px'
					textArea.style.top = '-999999px'
					document.body.appendChild(textArea)
					textArea.focus()
					textArea.select()
					
					// å°è¯•å¤åˆ¶
					const successful = document.execCommand('copy')
					document.body.removeChild(textArea)
					
					if (successful) {
						console.log('åå¤‡æ–¹æ¡ˆå¤åˆ¶æˆåŠŸ')
						uni.showModal({
							title: 'å¯¼å‡ºæˆåŠŸ',
							content: `å·²å°†${recordCount}æ¡è®°å½•å¤åˆ¶åˆ°å‰ªåˆ‡æ¿\n\næ‚¨å¯ä»¥ç²˜è´´åˆ°ä»»æ„æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ä¿å­˜ä¸ºCSVæ–‡ä»¶ï¼Œæˆ–ç›´æ¥åœ¨å…¶ä»–åº”ç”¨ä¸­ä½¿ç”¨ã€‚`,
							showCancel: false,
							confirmText: 'çŸ¥é“äº†'
						})
					} else {
						throw new Error('execCommand copy failed')
					}
				} catch (err) {
					console.error('åå¤‡æ–¹æ¡ˆä¹Ÿå¤±è´¥äº†:', err)
					// æœ€ç»ˆåå¤‡æ–¹æ¡ˆï¼šæ˜¾ç¤ºæ–‡æœ¬è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
					this.showManualCopyDialog(csvContent, recordCount)
				}
			},
			
			showManualCopyDialog(csvContent, recordCount) {
				console.log('=== æ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡† ===')
				const previewContent = csvContent.length > 500 ? 
					csvContent.substring(0, 500) + '\n...(æ•°æ®å·²æˆªæ–­ï¼Œè¯·å¤åˆ¶å®Œæ•´å†…å®¹)' : 
					csvContent
				
				uni.showModal({
					title: 'è¯·æ‰‹åŠ¨å¤åˆ¶',
					content: `è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼š\n\n${previewContent}`,
					showCancel: true,
					confirmText: 'å·²å¤åˆ¶',
					cancelText: 'å–æ¶ˆ',
					success: (res) => {
						if (res.confirm) {
							uni.showToast({
								title: 'æ“ä½œå®Œæˆ',
								icon: 'success'
							})
						}
					}
				})
			},
			
			parseCsvData(csvText) {
				console.log('=== å¼€å§‹è§£æCSVæ•°æ® ===')
				console.log('è¾“å…¥æ•°æ®ç±»å‹:', typeof csvText)
				console.log('è¾“å…¥æ•°æ®é•¿åº¦:', csvText ? csvText.length : 'undefined')
				
				try {
					// æ£€æŸ¥è¾“å…¥æ•°æ®
					if (!csvText || typeof csvText !== 'string') {
						console.error('æ•°æ®æ£€æŸ¥å¤±è´¥: æ•°æ®ä¸ºç©ºæˆ–ä¸æ˜¯å­—ç¬¦ä¸²ç±»å‹')
						uni.showToast({
							title: 'æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯',
							icon: 'none'
						})
						return
					}
					
					console.log('å¼€å§‹åˆ†å‰²æ•°æ®è¡Œ...')
					const lines = csvText.split('\n').filter(line => line.trim())
					console.log('æ€»è¡Œæ•°:', lines.length, 'æœ‰æ•ˆè¡Œæ•°:', lines.filter(line => line.trim()).length)
					
					if (lines.length === 0) {
						console.error('æ•°æ®æ£€æŸ¥å¤±è´¥: æ–‡ä»¶å†…å®¹ä¸ºç©º')
						uni.showToast({
							title: 'æ–‡ä»¶å†…å®¹ä¸ºç©º',
							icon: 'none'
						})
						return
					}
					
					const records = []
					const existingRecords = uni.getStorageSync('records') || []
					console.log('ç°æœ‰è®°å½•æ•°é‡:', existingRecords.length)
					
					// è·³è¿‡æ ‡é¢˜è¡Œï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
					let startIndex = 0
					if (lines.length > 0 && lines[0]) {
						const firstLine = lines[0].toLowerCase()
						console.log('ç¬¬ä¸€è¡Œå†…å®¹:', lines[0])
						console.log('ç¬¬ä¸€è¡Œå°å†™:', firstLine)
						if (firstLine.includes('æ—¶é—´') && firstLine.includes('ç±»å‹')) {
							startIndex = 1
							console.log('æ£€æµ‹åˆ°æ ‡é¢˜è¡Œï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹è§£æ')
						} else {
							console.log('æœªæ£€æµ‹åˆ°æ ‡é¢˜è¡Œï¼Œä»ç¬¬ä¸€è¡Œå¼€å§‹è§£æ')
						}
					}
					
					console.log('å¼€å§‹é€è¡Œè§£ææ•°æ®ï¼Œèµ·å§‹è¡Œ:', startIndex)
					for (let i = startIndex; i < lines.length; i++) {
						const line = lines[i].trim()
						console.log(`å¤„ç†ç¬¬${i+1}è¡Œ:`, line.substring(0, 100) + (line.length > 100 ? '...' : ''))
						
						if (!line) {
							console.log(`ç¬¬${i+1}è¡Œä¸ºç©ºï¼Œè·³è¿‡`)
							continue
						}
						
						// è§£æCSVè¡Œï¼ˆå¤„ç†å¸¦å¼•å·çš„å­—æ®µï¼‰
						console.log(`å¼€å§‹è§£æç¬¬${i+1}è¡Œçš„CSVå­—æ®µ...`)
						const fields = this.parseCSVLine(line)
						console.log(`ç¬¬${i+1}è¡Œè§£æå¾—åˆ°${fields.length}ä¸ªå­—æ®µ:`, fields)
						
						if (fields.length >= 4) {
							const timeStr = fields[0]
							const typeStr = fields[1]
							const categoryStr = fields[2]
							const amountStr = fields[3]
							const noteStr = fields[4] || ''
							
							console.log(`ç¬¬${i+1}è¡Œå­—æ®µè¯¦æƒ…:`, {
								time: timeStr,
								type: typeStr,
								category: categoryStr,
								amount: amountStr,
								note: noteStr
							})
							
							// éªŒè¯å’Œè½¬æ¢æ•°æ®
							console.log(`éªŒè¯ç¬¬${i+1}è¡Œæ•°æ®ç±»å‹...`)
							const type = typeStr === 'æ”¯å‡º' ? 'expense' : typeStr === 'æ”¶å…¥' ? 'income' : null
							if (!type) {
								console.log(`ç¬¬${i+1}è¡Œç±»å‹æ— æ•ˆ:`, typeStr, 'è·³è¿‡æ­¤è¡Œ')
								continue
							}
							console.log(`ç¬¬${i+1}è¡Œç±»å‹éªŒè¯é€šè¿‡:`, type)
							
							console.log(`è§£æç¬¬${i+1}è¡Œé‡‘é¢:`, amountStr)
							const amount = parseFloat(amountStr.replace(/[^\d.]/g, ''))
							if (isNaN(amount) || amount <= 0) {
								console.log(`ç¬¬${i+1}è¡Œé‡‘é¢æ— æ•ˆ:`, amountStr, '=>', amount, 'è·³è¿‡æ­¤è¡Œ')
								continue
							}
							console.log(`ç¬¬${i+1}è¡Œé‡‘é¢éªŒè¯é€šè¿‡:`, amount)
							
							// æŸ¥æ‰¾å¯¹åº”çš„åˆ†ç±»
							console.log(`æŸ¥æ‰¾ç¬¬${i+1}è¡Œåˆ†ç±»:`, categoryStr, type)
							const category = this.findCategoryByName(categoryStr, type)
							if (!category) {
								console.log(`ç¬¬${i+1}è¡Œæ‰¾ä¸åˆ°å¯¹åº”åˆ†ç±»:`, categoryStr, 'è·³è¿‡æ­¤è¡Œ')
								continue
							}
							console.log(`ç¬¬${i+1}è¡Œåˆ†ç±»åŒ¹é…æˆåŠŸ:`, category)
							
							// è§£ææ—¶é—´
							console.log(`è§£æç¬¬${i+1}è¡Œæ—¶é—´:`, timeStr)
							let time
							try {
								time = new Date(timeStr).toISOString()
								console.log(`ç¬¬${i+1}è¡Œæ—¶é—´è§£ææˆåŠŸ:`, time)
							} catch (e) {
								console.log(`ç¬¬${i+1}è¡Œæ—¶é—´è§£æå¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´:`, e.message)
								time = new Date().toISOString()
							}
							
							const record = {
								id: Date.now().toString() + '_import_' + i,
								type: type,
								amount: amount.toFixed(2),
								categoryId: category.id,
								categoryName: category.name,
								categoryIcon: category.icon,
								note: noteStr,
								time: time
							}
							
							console.log(`ç¬¬${i+1}è¡Œè®°å½•åˆ›å»ºæˆåŠŸ:`, record)
							records.push(record)
						} else {
							console.log(`ç¬¬${i+1}è¡Œå­—æ®µæ•°é‡ä¸è¶³(${fields.length}/4)ï¼Œè·³è¿‡æ­¤è¡Œ`)
						}
					}
					
					console.log('æ•°æ®è§£æå®Œæˆï¼Œæœ‰æ•ˆè®°å½•æ•°:', records.length)
					
					if (records.length > 0) {
						// åˆå¹¶åˆ°ç°æœ‰æ•°æ®
						console.log('å¼€å§‹åˆå¹¶æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨...')
						const allRecords = [...existingRecords, ...records]
						console.log('åˆå¹¶åæ€»è®°å½•æ•°:', allRecords.length)
						
						uni.setStorageSync('records', allRecords)
						console.log('æ•°æ®ä¿å­˜æˆåŠŸ')
						
						uni.showModal({
							title: 'å¯¼å…¥æˆåŠŸ',
							content: `æˆåŠŸå¯¼å…¥ ${records.length} æ¡è®°å½•ï¼`,
							showCancel: false
						})
						console.log('=== CSVå¯¼å…¥æµç¨‹å®Œæˆ ===')
					} else {
						console.log('æ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯å¯¼å…¥')
						uni.showToast({
							title: 'æ²¡æœ‰æœ‰æ•ˆæ•°æ®å¯å¯¼å…¥',
							icon: 'none'
						})
					}
				} catch (error) {
					console.error('=== CSVè§£æå‡ºç°å¼‚å¸¸ ===')
					console.error('é”™è¯¯ç±»å‹:', error.name)
					console.error('é”™è¯¯ä¿¡æ¯:', error.message)
					console.error('é”™è¯¯å †æ ˆ:', error.stack)
					console.error('è¾“å…¥æ•°æ®:', csvText)
					
					uni.showModal({
						title: 'æ•°æ®æ ¼å¼é”™è¯¯',
						content: 'è¯·æ£€æŸ¥CSVæ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®\n\næ­£ç¡®æ ¼å¼ï¼š\næ—¶é—´,ç±»å‹,åˆ†ç±»,é‡‘é¢,å¤‡æ³¨\n\nç¤ºä¾‹ï¼š\n"2024-01-01 12:00","æ”¯å‡º","é¤é¥®","25.50","åˆé¤"',
						showCancel: false,
						confirmText: 'çŸ¥é“äº†'
					})
				}
			},
			
			importFromFile() {
				console.log('=== å¼€å§‹æ–‡ä»¶å¯¼å…¥æµç¨‹ ===')
				console.log('æ£€æµ‹å½“å‰å¹³å°...')
				
				// è¿è¡Œæ—¶å¹³å°æ£€æµ‹
				console.log('è¿è¡Œæ—¶ç¯å¢ƒä¿¡æ¯:')
				console.log('- uni å¯¹è±¡å­˜åœ¨:', typeof uni !== 'undefined')
				console.log('- wx å¯¹è±¡å­˜åœ¨:', typeof wx !== 'undefined')
				console.log('- plus å¯¹è±¡å­˜åœ¨:', typeof plus !== 'undefined')
				console.log('- document å¯¹è±¡å­˜åœ¨:', typeof document !== 'undefined')
				console.log('- window å¯¹è±¡å­˜åœ¨:', typeof window !== 'undefined')
				
				// uni-app å¹³å°ä¿¡æ¯
				if (typeof uni !== 'undefined' && uni.getSystemInfoSync) {
					try {
						const systemInfo = uni.getSystemInfoSync()
						console.log('ç³»ç»Ÿä¿¡æ¯:', systemInfo)
						console.log('å¹³å°:', systemInfo.platform)
						console.log('ç³»ç»Ÿ:', systemInfo.system)
						console.log('å“ç‰Œ:', systemInfo.brand)
						console.log('å‹å·:', systemInfo.model)
					} catch (e) {
						console.log('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥:', e)
					}
				}
				
				// æ£€æŸ¥å¹³å°å’ŒAPIæ”¯æŒ
				// #ifdef H5
				console.log('ç¼–è¯‘å¹³å°: H5ï¼Œä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨')
				// H5å¹³å°ä½¿ç”¨input file
				this.importFromFileH5()
				// #endif
				
				// #ifdef APP-PLUS
				console.log('ç¼–è¯‘å¹³å°: APP-PLUSï¼Œä½¿ç”¨plus.io')
				// Appå¹³å°ä½¿ç”¨plus.io
				this.importFromFileApp()
				// #endif
				
				// #ifdef MP-WEIXIN
				console.log('ç¼–è¯‘å¹³å°: å¾®ä¿¡å°ç¨‹åºï¼Œä½¿ç”¨wx.chooseMessageFile')
				// å¾®ä¿¡å°ç¨‹åºå¹³å°çš„å¤„ç†
				this.importFromFileWx()
				// #endif
				
				// #ifdef MP && !MP-WEIXIN
				console.log('ç¼–è¯‘å¹³å°: å…¶ä»–å°ç¨‹åºï¼Œé™çº§å¤„ç†')
				// å…¶ä»–å°ç¨‹åºå¹³å°å¤„ç†
				this.fallbackImport()
				// #endif
				
				// #ifndef H5 || APP-PLUS || MP
				console.log('ç¼–è¯‘å¹³å°: æœªçŸ¥å¹³å°ï¼Œé™çº§å¤„ç†')
				// å…¶ä»–å¹³å°é™çº§å¤„ç†
				this.fallbackImport()
				// #endif
			},
			
			importFromFileWx() {
				console.log('=== å¾®ä¿¡å°ç¨‹åºæ–‡ä»¶é€‰æ‹©æµç¨‹ ===')
				// å¾®ä¿¡å°ç¨‹åºé€‰æ‹©æ–‡ä»¶
				wx.chooseMessageFile({
					count: 1,
					type: 'file',
					success: (res) => {
						console.log('æ–‡ä»¶é€‰æ‹©æˆåŠŸ:', res)
						const file = res.tempFiles[0]
						console.log('é€‰æ‹©çš„æ–‡ä»¶:', file)
						console.log('æ–‡ä»¶å:', file.name)
						console.log('æ–‡ä»¶å¤§å°:', file.size)
						console.log('æ–‡ä»¶è·¯å¾„:', file.path)
						
						if (!file.name.toLowerCase().endsWith('.csv') && !file.name.toLowerCase().endsWith('.txt')) {
							console.log('æ–‡ä»¶ç±»å‹æ£€æŸ¥å¤±è´¥:', file.name)
							uni.showToast({
								title: 'è¯·é€‰æ‹©CSVæˆ–TXTæ–‡ä»¶',
								icon: 'none'
							})
							return
						}
						console.log('æ–‡ä»¶ç±»å‹æ£€æŸ¥é€šè¿‡')
						
						console.log('å¼€å§‹è¯»å–æ–‡ä»¶å†…å®¹...')
						const fs = wx.getFileSystemManager()
						
						if (!fs) {
							console.error('æ— æ³•è·å–æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨')
							uni.showToast({
								title: 'æ–‡ä»¶ç³»ç»Ÿä¸å¯ç”¨',
								icon: 'error'
							})
							return
						}
						
						console.log('æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨è·å–æˆåŠŸï¼Œå¼€å§‹è¯»å–æ–‡ä»¶:', file.path)
						
						fs.readFile({
							filePath: file.path,
							encoding: 'utf8',
							success: (fileRes) => {
								console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼')
								console.log('è¯»å–ç»“æœ:', fileRes)
								console.log('æ•°æ®ç±»å‹:', typeof fileRes.data)
								console.log('æ•°æ®é•¿åº¦:', fileRes.data ? fileRes.data.length : 'undefined')
								console.log('æ–‡ä»¶å†…å®¹é¢„è§ˆ:', fileRes.data ? fileRes.data.substring(0, 200) + (fileRes.data.length > 200 ? '...' : '') : 'æ— å†…å®¹')
								
								if (!fileRes.data) {
									console.error('è¯»å–åˆ°çš„æ–‡ä»¶å†…å®¹ä¸ºç©º')
									uni.showToast({
										title: 'æ–‡ä»¶å†…å®¹ä¸ºç©º',
										icon: 'error'
									})
									return
								}
								
								if (typeof fileRes.data !== 'string') {
									console.error('è¯»å–åˆ°çš„å†…å®¹ä¸æ˜¯å­—ç¬¦ä¸²ç±»å‹:', typeof fileRes.data)
									uni.showToast({
										title: 'æ–‡ä»¶æ ¼å¼é”™è¯¯',
										icon: 'error'
									})
									return
								}
								
								console.log('æ–‡ä»¶å†…å®¹æœ‰æ•ˆï¼Œå¼€å§‹è§£æCSV...')
								this.parseCsvData(fileRes.data)
							},
							fail: (err) => {
								console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', err)
								console.error('é”™è¯¯å¯¹è±¡å®Œæ•´ä¿¡æ¯:', JSON.stringify(err, null, 2))
								console.error('é”™è¯¯æ¶ˆæ¯:', err.errMsg || err.message || 'æœªçŸ¥é”™è¯¯')
								console.error('é”™è¯¯ä»£ç :', err.errCode || err.code || 'æ— ä»£ç ')
								
								uni.showToast({
									title: 'è¯»å–æ–‡ä»¶å¤±è´¥: ' + (err.errMsg || err.message || 'æœªçŸ¥é”™è¯¯'),
									icon: 'error'
								})
							}
						})
					},
					fail: (err) => {
						console.log('æ–‡ä»¶é€‰æ‹©å¤±è´¥:', err)
						// æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·å–æ¶ˆæ“ä½œ
						if (err.errMsg && err.errMsg.includes('cancel')) {
							console.log('ç”¨æˆ·å–æ¶ˆæ–‡ä»¶é€‰æ‹©(é€šè¿‡errMsgæ£€æµ‹)')
							// ç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œä¸æ˜¾ç¤ºé”™è¯¯æç¤º
							return
						}
						if (err.code === 12 || (err.message && err.message.includes('cancelled'))) {
							console.log('ç”¨æˆ·å–æ¶ˆæ–‡ä»¶é€‰æ‹©(é€šè¿‡code/messageæ£€æµ‹)')
							// ç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œä¸æ˜¾ç¤ºé”™è¯¯æç¤º
							return
						}
						// å…¶ä»–é”™è¯¯æ‰æç¤ºé™çº§
						console.log('æ–‡ä»¶é€‰æ‹©å‡ºç°å…¶ä»–é”™è¯¯ï¼Œå¯åŠ¨é™çº§æ–¹æ¡ˆ')
						this.fallbackImport()
					}
				})
			},
			
			importFromFileApp() {
				// Appå¹³å°ä½¿ç”¨æ–‡æ¡£é€‰æ‹©å™¨
				if (typeof plus !== 'undefined') {
					// ä½¿ç”¨æ–‡æ¡£é€‰æ‹©å™¨
					plus.io.requestFileSystem(plus.io.PRIVATE_DOC, (fs) => {
						// ç›´æ¥è°ƒç”¨ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
						plus.gallery.pick((path) => {
							// è¿™é‡Œå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºgalleryä¸»è¦ç”¨äºå›¾ç‰‡
							// æ”¹ç”¨æ›´é€šç”¨çš„æ–¹æ³•
							this.showFilePickerApp()
						}, (err) => {
							console.error('é€‰æ‹©æ–‡ä»¶å¤±è´¥:', err)
							this.showFilePickerApp()
						}, {
							filter: "file"
						})
					})
				} else {
					this.fallbackImport()
				}
			},
			
			showFilePickerApp() {
				// Appå¹³å°çš„æ–‡ä»¶é€‰æ‹©å®ç°
				if (typeof plus !== 'undefined') {
					// æ˜¾ç¤ºé€‰æ‹©æ–¹å¼
					uni.showActionSheet({
						itemList: ['ä»ä¸‹è½½ç›®å½•é€‰æ‹©', 'ä»æ–‡æ¡£ç›®å½•é€‰æ‹©', 'æ‰‹åŠ¨è¾“å…¥è·¯å¾„'],
						success: (res) => {
							if (res.tapIndex === 0) {
								this.selectFromDownloads()
							} else if (res.tapIndex === 1) {
								this.selectFromDocuments()
							} else if (res.tapIndex === 2) {
								this.manualInputPath()
							}
						}
					})
				} else {
					this.fallbackImport()
				}
			},
			
			selectFromDownloads() {
				plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS, (fs) => {
					fs.root.createReader().readEntries((entries) => {
						const csvFiles = entries.filter(entry => 
							entry.name.toLowerCase().endsWith('.csv') || 
							entry.name.toLowerCase().endsWith('.txt')
						)
						
						if (csvFiles.length === 0) {
							uni.showToast({
								title: 'ä¸‹è½½ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°CSVæ–‡ä»¶',
								icon: 'none'
							})
							return
						}
						
						// æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©åˆ—è¡¨
						const fileNames = csvFiles.map(file => file.name)
						uni.showActionSheet({
							itemList: fileNames,
							success: (res) => {
								const selectedFile = csvFiles[res.tapIndex]
								this.readFileContent(selectedFile)
							}
						})
					})
				}, (err) => {
					console.error('è®¿é—®ä¸‹è½½ç›®å½•å¤±è´¥:', err)
					this.fallbackImport()
				})
			},
			
			selectFromDocuments() {
				plus.io.requestFileSystem(plus.io.PRIVATE_DOC, (fs) => {
					fs.root.createReader().readEntries((entries) => {
						const csvFiles = entries.filter(entry => 
							entry.name.toLowerCase().endsWith('.csv') || 
							entry.name.toLowerCase().endsWith('.txt')
						)
						
						if (csvFiles.length === 0) {
							uni.showToast({
								title: 'æ–‡æ¡£ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°CSVæ–‡ä»¶',
								icon: 'none'
							})
							return
						}
						
						// æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©åˆ—è¡¨
						const fileNames = csvFiles.map(file => file.name)
						uni.showActionSheet({
							itemList: fileNames,
							success: (res) => {
								const selectedFile = csvFiles[res.tapIndex]
								this.readFileContent(selectedFile)
							}
						})
					})
				}, (err) => {
					console.error('è®¿é—®æ–‡æ¡£ç›®å½•å¤±è´¥:', err)
					this.fallbackImport()
				})
			},
			
			manualInputPath() {
				uni.showModal({
					title: 'è¾“å…¥æ–‡ä»¶è·¯å¾„',
					content: 'è¯·è¾“å…¥CSVæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼š',
					editable: true,
					placeholderText: '/storage/emulated/0/Download/data.csv',
					success: (res) => {
						if (res.confirm && res.content && res.content.trim()) {
							this.readFileFromPath(res.content.trim())
						}
					}
				})
			},
			
			readFileFromPath(filePath) {
				plus.io.resolveLocalFileSystemURL(filePath, (entry) => {
					this.readFileContent(entry)
				}, (err) => {
					console.error('æ–‡ä»¶è·¯å¾„é”™è¯¯:', err)
					uni.showToast({
						title: 'æ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„é”™è¯¯',
						icon: 'none'
					})
				})
			},
			
			readFileContent(fileEntry) {
				fileEntry.file((file) => {
					const reader = new plus.io.FileReader()
					reader.onload = (e) => {
						this.parseCsvData(e.target.result)
					}
					reader.onerror = (err) => {
						console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', err)
						uni.showToast({
							title: 'è¯»å–æ–‡ä»¶å¤±è´¥',
							icon: 'none'
						})
					}
					reader.readAsText(file, 'UTF-8')
				}, (err) => {
					console.error('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥:', err)
					uni.showToast({
						title: 'è·å–æ–‡ä»¶å†…å®¹å¤±è´¥',
						icon: 'none'
					})
				})
			},
			
			fallbackImport() {
				uni.showModal({
					title: 'å¯¼å…¥æç¤º',
					content: 'å½“å‰ç¯å¢ƒä¸æ”¯æŒæ–‡ä»¶é€‰æ‹©ï¼Œè¯·ä½¿ç”¨"ç²˜è´´CSVæ•°æ®å¯¼å…¥"åŠŸèƒ½',
					showCancel: false,
					success: () => {
						this.showCsvImportDialog()
					}
				})
			},
			
			importFromFileH5() {
				console.log('=== H5å¹³å°æ–‡ä»¶é€‰æ‹©æµç¨‹ ===')
				// H5å¹³å°çš„æ–‡ä»¶é€‰æ‹©å®ç°
				const input = document.createElement('input')
				input.type = 'file'
				input.accept = '.csv,.txt'
				input.style.display = 'none'
				console.log('åˆ›å»ºæ–‡ä»¶é€‰æ‹©å…ƒç´ :', input)
				
				input.onchange = (event) => {
					console.log('=== H5æ–‡ä»¶é€‰æ‹©changeäº‹ä»¶è§¦å‘ ===')
					console.log('äº‹ä»¶å¯¹è±¡:', event)
					console.log('target:', event.target)
					console.log('files:', event.target.files)
					console.log('filesé•¿åº¦:', event.target.files ? event.target.files.length : 0)
					
					const file = event.target.files[0]
					console.log('é€‰æ‹©çš„æ–‡ä»¶å¯¹è±¡:', file)
					
					if (!file) {
						console.log('æœªé€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶ä¸ºç©º')
						uni.showToast({
							title: 'æœªé€‰æ‹©æ–‡ä»¶',
							icon: 'none'
						})
						return
					}
					
					console.log('æ–‡ä»¶åŸºæœ¬ä¿¡æ¯:', {
						name: file.name,
						size: file.size,
						type: file.type,
						lastModified: file.lastModified,
						lastModifiedDate: file.lastModifiedDate
					})
					
					// æ£€æŸ¥æ–‡ä»¶å¤§å°
					if (file.size === 0) {
						console.error('æ–‡ä»¶å¤§å°ä¸º0')
						uni.showToast({
							title: 'æ–‡ä»¶ä¸ºç©º',
							icon: 'error'
						})
						return
					}
					
					if (file.size > 5 * 1024 * 1024) { // 5MBé™åˆ¶
						console.error('æ–‡ä»¶è¿‡å¤§:', file.size)
						uni.showToast({
							title: 'æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB',
							icon: 'error'
						})
						return
					}
					
					console.log('æ–‡ä»¶å¤§å°æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹è¯»å–æ–‡ä»¶å†…å®¹...')
					const reader = new FileReader()
					
					reader.onload = (e) => {
						console.log('=== FileReaderè¯»å–å®Œæˆ ===')
						console.log('è¯»å–äº‹ä»¶:', e)
						console.log('è¯»å–ç›®æ ‡:', e.target)
						console.log('è¯»å–çŠ¶æ€:', e.target.readyState)
						
						const content = e.target.result
						console.log('è¯»å–ç»“æœç±»å‹:', typeof content)
						console.log('å†…å®¹æ˜¯å¦ä¸ºnull:', content === null)
						console.log('å†…å®¹æ˜¯å¦ä¸ºundefined:', content === undefined)
						
						if (!content) {
							console.error('è¯»å–åˆ°çš„å†…å®¹ä¸ºç©º')
							uni.showToast({
								title: 'æ–‡ä»¶å†…å®¹ä¸ºç©º',
								icon: 'error'
							})
							return
						}
						
						if (typeof content !== 'string') {
							console.error('è¯»å–åˆ°çš„å†…å®¹ä¸æ˜¯å­—ç¬¦ä¸²:', typeof content)
							uni.showToast({
								title: 'æ–‡ä»¶æ ¼å¼é”™è¯¯',
								icon: 'error'
							})
							return
						}
						
						console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼')
						console.log('å†…å®¹é•¿åº¦:', content.length)
						console.log('å†…å®¹é¢„è§ˆ:', content.substring(0, 200) + (content.length > 200 ? '...' : ''))
						console.log('å¼€å§‹è§£æCSVæ•°æ®...')
						
						this.parseCsvData(content)
					}
					
					reader.onerror = (e) => {
						console.error('=== FileReaderè¯»å–å¤±è´¥ ===')
						console.error('é”™è¯¯äº‹ä»¶:', e)
						console.error('é”™è¯¯ç›®æ ‡:', e.target)
						console.error('é”™è¯¯çŠ¶æ€:', e.target.readyState)
						console.error('é”™è¯¯è¯¦æƒ…:', e.target.error)
						
						uni.showToast({
							title: 'è¯»å–æ–‡ä»¶å¤±è´¥: ' + (e.target.error ? e.target.error.message : 'æœªçŸ¥é”™è¯¯'),
							icon: 'error'
						})
					}
					
					reader.onabort = (e) => {
						console.log('=== FileReaderè¯»å–è¢«ä¸­æ­¢ ===')
						console.log('ä¸­æ­¢äº‹ä»¶:', e)
						uni.showToast({
							title: 'æ–‡ä»¶è¯»å–è¢«ä¸­æ­¢',
							icon: 'none'
						})
					}
					
					console.log('å¼€å§‹FileReader.readAsTextæ“ä½œ...')
					reader.readAsText(file, 'UTF-8')
					
					// æ¸…ç†DOMå…ƒç´ 
					console.log('æ¸…ç†æ–‡ä»¶é€‰æ‹©å…ƒç´ ')
					document.body.removeChild(input)
				}
				
				// ç”¨æˆ·å–æ¶ˆé€‰æ‹©æ–‡ä»¶æ—¶çš„å¤„ç†
				input.oncancel = () => {
					console.log('æ–‡ä»¶é€‰æ‹©canceläº‹ä»¶è§¦å‘')
					document.body.removeChild(input)
				}
				
				// ç›‘å¬çª—å£ç„¦ç‚¹å˜åŒ–æ¥æ£€æµ‹ç”¨æˆ·æ˜¯å¦å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©
				let timeoutId = null
				const handleFocus = () => {
					console.log('çª—å£è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥æ–‡ä»¶é€‰æ‹©çŠ¶æ€')
					// å»¶è¿Ÿæ£€æŸ¥ï¼Œç»™æ–‡ä»¶é€‰æ‹©ä¸€äº›æ—¶é—´
					timeoutId = setTimeout(() => {
						if (input.files.length === 0) {
							console.log('ç”¨æˆ·å¯èƒ½å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©ï¼Œæ¸…ç†DOM')
							// ç”¨æˆ·å¯èƒ½å–æ¶ˆäº†é€‰æ‹©ï¼Œæ¸…ç†DOM
							try {
								document.body.removeChild(input)
							} catch (e) {
								console.log('DOMå…ƒç´ å·²è¢«ç§»é™¤')
								// DOMå…ƒç´ å¯èƒ½å·²ç»è¢«ç§»é™¤
							}
						}
						window.removeEventListener('focus', handleFocus)
					}, 100)
				}
				
				window.addEventListener('focus', handleFocus)
				
				console.log('æ·»åŠ æ–‡ä»¶é€‰æ‹©å…ƒç´ åˆ°DOMå¹¶è§¦å‘ç‚¹å‡»')
				document.body.appendChild(input)
				input.click()
			},
			
			parseCSVLine(line) {
				console.log('å¼€å§‹è§£æCSVè¡Œ:', line)
				// é˜²æ­¢ç©ºè¡Œæˆ–undefined
				if (!line || typeof line !== 'string') {
					console.log('CSVè¡Œæ— æ•ˆï¼Œè¿”å›ç©ºæ•°ç»„')
					return []
				}
				
				const result = []
				let current = ''
				let inQuotes = false
				let i = 0
				
				console.log('å¼€å§‹é€å­—ç¬¦è§£æï¼Œæ€»é•¿åº¦:', line.length)
				while (i < line.length) {
					const char = line[i]
					
					if (char === '"') {
						inQuotes = !inQuotes
						console.log(`å­—ç¬¦${i}: å¼•å·ï¼ŒinQuotes=${inQuotes}`)
					} else if (char === ',' && !inQuotes) {
						result.push(current.trim())
						console.log(`å­—ç¬¦${i}: é€—å·(éå¼•å·å†…)ï¼Œæ·»åŠ å­—æ®µ: "${current.trim()}"`)
						current = ''
					} else {
						current += char
					}
					i++
				}
				
				result.push(current.trim())
				console.log(`è§£æå®Œæˆï¼Œæœ€åæ·»åŠ å­—æ®µ: "${current.trim()}"`)
				
				// ç§»é™¤å¼•å·
				const finalResult = result.map(field => field.replace(/^"|"$/g, ''))
				console.log('ç§»é™¤å¼•å·åçš„æœ€ç»ˆç»“æœ:', finalResult)
				return finalResult
			},
			
			findCategoryByName(categoryName, type) {
				console.log('æŸ¥æ‰¾åˆ†ç±»:', categoryName, 'ç±»å‹:', type)
				// ä»å­˜å‚¨ä¸­åŠ è½½åˆ†ç±»æ•°æ®
				const expenseCategories = uni.getStorageSync('expenseCategories') || this.defaultExpenseCategories
				const incomeCategories = uni.getStorageSync('incomeCategories') || this.defaultIncomeCategories
				const categories = type === 'expense' ? expenseCategories : incomeCategories
				
				console.log('å¯ç”¨åˆ†ç±»åˆ—è¡¨:', categories.map(cat => cat.name))
				
				// ç²¾ç¡®åŒ¹é…
				let category = categories.find(cat => cat.name === categoryName)
				if (category) {
					console.log('ç²¾ç¡®åŒ¹é…æˆåŠŸ:', category)
					return category
				}
				
				// æ‰¾ä¸åˆ°åˆ™ä½¿ç”¨"å…¶ä»–"
				category = categories.find(cat => cat.name === 'å…¶ä»–')
				console.log('ä½¿ç”¨é»˜è®¤åˆ†ç±»"å…¶ä»–":', category)
				return category
			},
			
			createSampleData() {
				console.log('=== å¼€å§‹åˆ›å»ºç¤ºä¾‹æ•°æ® ===')
				const existingRecords = uni.getStorageSync('records') || []
				console.log('å½“å‰å·²æœ‰è®°å½•æ•°:', existingRecords.length)
				
				// åˆ›å»ºä¸€äº›ç¤ºä¾‹æ•°æ®
				const sampleData = [
					{
						id: Date.now().toString() + '_sample1',
						type: 'expense',
						amount: '35.80',
						categoryId: 1,
						categoryName: 'é¤é¥®',
						categoryIcon: 'ğŸ½ï¸',
						note: 'åˆé¤ - ç¤ºä¾‹æ•°æ®',
						time: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
					},
					{
						id: Date.now().toString() + '_sample2',
						type: 'expense',
						amount: '12.00',
						categoryId: 2,
						categoryName: 'äº¤é€š',
						categoryIcon: 'ğŸš—',
						note: 'åœ°é“è´¹ - ç¤ºä¾‹æ•°æ®',
						time: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
					},
					{
						id: Date.now().toString() + '_sample3',
						type: 'expense',
						amount: '199.00',
						categoryId: 3,
						categoryName: 'è´­ç‰©',
						categoryIcon: 'ğŸ›ï¸',
						note: 'ä¹°è¡£æœ - ç¤ºä¾‹æ•°æ®',
						time: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()
					},
					{
						id: Date.now().toString() + '_sample4',
						type: 'income',
						amount: '3000.00',
						categoryId: 11,
						categoryName: 'å·¥èµ„',
						categoryIcon: 'ğŸ’°',
						note: 'éƒ¨åˆ†å·¥èµ„ - ç¤ºä¾‹æ•°æ®',
						time: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString()
					},
					{
						id: Date.now().toString() + '_sample5',
						type: 'expense',
						amount: '88.50',
						categoryId: 4,
						categoryName: 'å¨±ä¹',
						categoryIcon: 'ğŸ¬',
						note: 'ç”µå½±ç¥¨ - ç¤ºä¾‹æ•°æ®',
						time: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
					},
					{
						id: Date.now().toString() + '_sample6',
						type: 'income',
						amount: '200.00',
						categoryId: 15,
						categoryName: 'çº¢åŒ…',
						categoryIcon: 'ğŸ§§',
						note: 'ç”Ÿæ—¥çº¢åŒ… - ç¤ºä¾‹æ•°æ®',
						time: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString()
					}
				]
				
				console.log('åˆ›å»ºçš„ç¤ºä¾‹æ•°æ®:', sampleData)
				
				// åˆå¹¶æ•°æ®
				const allRecords = [...existingRecords, ...sampleData]
				console.log('åˆå¹¶åæ€»è®°å½•æ•°:', allRecords.length)
				
				uni.setStorageSync('records', allRecords)
				console.log('ç¤ºä¾‹æ•°æ®ä¿å­˜æˆåŠŸ')
				
				uni.showToast({
					title: `æˆåŠŸå¯¼å…¥${sampleData.length}æ¡ç¤ºä¾‹æ•°æ®`,
					icon: 'success',
					duration: 2000
				})
				console.log('=== ç¤ºä¾‹æ•°æ®åˆ›å»ºæµç¨‹å®Œæˆ ===')
			},
			
			exportData() {
				const records = uni.getStorageSync('records') || []
				if (records.length === 0) {
					uni.showToast({
						title: 'æš‚æ— æ•°æ®å¯å¯¼å‡º',
						icon: 'none'
					})
					return
				}
				
				// æ ¼å¼åŒ–æ•°æ®ä¸ºCSVæ ¼å¼ï¼ˆæ‰€æœ‰å¹³å°éƒ½éœ€è¦ï¼‰
				let csvContent = 'æ—¶é—´,ç±»å‹,åˆ†ç±»,é‡‘é¢,å¤‡æ³¨\n'
				records.forEach(record => {
					const time = new Date(record.time).toLocaleString('zh-CN')
					const type = record.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'
					const category = record.categoryName
					const amount = record.amount
					const note = record.note || ''
					csvContent += `"${time}","${type}","${category}","${amount}","${note}"\n`
				})
				
				// æ£€æŸ¥å¹³å°æ”¯æŒ
				// #ifdef APP-PLUS
				if (typeof plus === 'undefined') {
					uni.showToast({
						title: 'å½“å‰ç¯å¢ƒä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—®',
						icon: 'none'
					})
					return
				}
				
				// æ˜¾ç¤ºé€‰æ‹©å¯¼å‡ºæ–¹å¼
				uni.showActionSheet({
					itemList: ['ä¿å­˜åˆ°ä¸‹è½½ç›®å½•', 'ä¿å­˜åˆ°æ–‡æ¡£ç›®å½•', 'æ‰‹åŠ¨è¾“å…¥è·¯å¾„', 'å¤åˆ¶åˆ°å‰ªåˆ‡æ¿'],
					success: (res) => {
						const now = new Date()
						const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '')
						const fileName = `è®°è´¦æ•°æ®_${dateStr}.csv`
						
						if (res.tapIndex === 0) {
							this.saveToDownloads(csvContent, records.length, fileName)
						} else if (res.tapIndex === 1) {
							this.saveToDocuments(csvContent, records.length, fileName)
						} else if (res.tapIndex === 2) {
							this.saveToCustomLocation(csvContent, records.length, fileName)
						} else if (res.tapIndex === 3) {
							this.exportToClipboard(csvContent, records.length)
						}
					}
				})
				// #endif
				
				// #ifndef APP-PLUS
				uni.showActionSheet({
					itemList: ['å¤åˆ¶åˆ°å‰ªåˆ‡æ¿'],
					success: (res) => {
						if (res.tapIndex === 0) {
							this.exportToClipboard(csvContent, records.length)
						}
					}
				})
				// #endif
			},
			
			saveToFile(csvContent, recordCount) {
				// ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«å½“å‰æ—¥æœŸï¼‰
				const now = new Date()
				const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '')
				const fileName = `è®°è´¦æ•°æ®_${dateStr}.csv`
				
				// #ifdef H5
				// H5å¹³å°ç›´æ¥ä¸‹è½½
				this.downloadFileH5(csvContent, fileName, recordCount)
				// #endif
				
				// #ifdef APP-PLUS
				// Appå¹³å°é€‰æ‹©ä¿å­˜ä½ç½®
				this.selectSaveLocationApp(csvContent, recordCount, fileName)
				// #endif
				
				// #ifdef MP-WEIXIN
				// å¾®ä¿¡å°ç¨‹åºä¿å­˜åˆ°ç›¸å†Œæˆ–åˆ†äº«
				this.saveFileWx(csvContent, recordCount, fileName)
				// #endif
				
				// #ifdef MP && !MP-WEIXIN
				// å…¶ä»–å°ç¨‹åºå¹³å°
				this.fallbackExport(csvContent, recordCount)
				// #endif
				
				// #ifndef H5 || APP-PLUS || MP
				// å…¶ä»–å¹³å°é™çº§åˆ°å¤åˆ¶
				this.fallbackExport(csvContent, recordCount)
				// #endif
			},
			
			selectSaveLocationApp(csvContent, recordCount, fileName) {
				// Appå¹³å°é€‰æ‹©ä¿å­˜ä½ç½®
				if (typeof plus !== 'undefined') {
					uni.showActionSheet({
						itemList: ['ä¿å­˜åˆ°ä¸‹è½½ç›®å½•', 'ä¿å­˜åˆ°æ–‡æ¡£ç›®å½•', 'é€‰æ‹©è‡ªå®šä¹‰ç›®å½•'],
						success: (res) => {
							if (res.tapIndex === 0) {
								this.saveToDownloads(csvContent, recordCount, fileName)
							} else if (res.tapIndex === 1) {
								this.saveToDocuments(csvContent, recordCount, fileName)
							} else if (res.tapIndex === 2) {
								this.saveToCustomLocation(csvContent, recordCount, fileName)
							}
						}
					})
				} else {
					this.fallbackExport(csvContent, recordCount)
				}
			},
			
			saveToDownloads(csvContent, recordCount, fileName) {
				console.log('=== å¼€å§‹ä¿å­˜åˆ°ä¸‹è½½ç›®å½• ===')
				console.log('æ–‡ä»¶å:', fileName)
				console.log('è®°å½•æ•°é‡:', recordCount)
				console.log('CSVå†…å®¹é•¿åº¦:', csvContent.length)
				console.log('CSVå†…å®¹é¢„è§ˆ:', csvContent.substring(0, 200))
				
				plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS, (fs) => {
					console.log('è·å–ä¸‹è½½ç›®å½•æ–‡ä»¶ç³»ç»ŸæˆåŠŸ')
					fs.root.getFile(fileName, {create: true}, (fileEntry) => {
						console.log('åˆ›å»ºæ–‡ä»¶æˆåŠŸ:', fileEntry.fullPath)
						fileEntry.createWriter((writer) => {
							console.log('åˆ›å»ºå†™å…¥å™¨æˆåŠŸ')
							
							writer.onwrite = (e) => {
								console.log('æ–‡ä»¶å†™å…¥å®Œæˆäº‹ä»¶:', e)
								console.log('å†™å…¥å™¨ä½ç½®:', writer.position)
								console.log('å†™å…¥å™¨é•¿åº¦:', writer.length)
								uni.showModal({
									title: 'å¯¼å‡ºæˆåŠŸ',
									content: `æ–‡ä»¶å·²ä¿å­˜åˆ°ä¸‹è½½ç›®å½•ï¼š\n${fileName}\n\nå…±${recordCount}æ¡è®°å½•\næ–‡ä»¶å¤§å°ï¼š${writer.length}å­—èŠ‚`,
									showCancel: false,
									confirmText: 'çŸ¥é“äº†'
								})
							}
							
							writer.onerror = (err) => {
								console.error('å†™å…¥å¤±è´¥:', err)
								uni.showToast({
									title: 'æ–‡ä»¶å†™å…¥å¤±è´¥',
									icon: 'error'
								})
							}
							
							writer.onwriteend = () => {
								console.log('å†™å…¥ç»“æŸï¼Œæœ€ç»ˆæ–‡ä»¶å¤§å°:', writer.length)
							}
							
							// åˆ›å»ºå¸¦BOMçš„UTF-8 CSVå†…å®¹
							const bom = '\ufeff'
							const fullContent = bom + csvContent
							console.log('å®Œæ•´å†…å®¹é•¿åº¦(å«BOM):', fullContent.length)
							
							// å†™å…¥æ•°æ®
							console.log('å¼€å§‹å†™å…¥æ•°æ®...')
							writer.write(fullContent)
						}, (err) => {
							console.error('åˆ›å»ºå†™å…¥å™¨å¤±è´¥:', err)
							uni.showToast({
								title: 'åˆ›å»ºå†™å…¥å™¨å¤±è´¥',
								icon: 'error'
							})
						})
					}, (err) => {
						console.error('åˆ›å»ºæ–‡ä»¶å¤±è´¥:', err)
						uni.showToast({
							title: 'åˆ›å»ºæ–‡ä»¶å¤±è´¥',
							icon: 'error'
						})
					})
				}, (err) => {
					console.error('è·å–ä¸‹è½½ç›®å½•å¤±è´¥:', err)
					uni.showToast({
						title: 'è·å–ä¸‹è½½ç›®å½•å¤±è´¥',
						icon: 'error'
					})
				})
			},
			
			saveToDocuments(csvContent, recordCount, fileName) {
				console.log('=== å¼€å§‹ä¿å­˜åˆ°æ–‡æ¡£ç›®å½• ===')
				console.log('æ–‡ä»¶å:', fileName)
				console.log('è®°å½•æ•°é‡:', recordCount)
				console.log('CSVå†…å®¹é•¿åº¦:', csvContent.length)
				console.log('CSVå†…å®¹é¢„è§ˆ:', csvContent.substring(0, 200))
				
				plus.io.requestFileSystem(plus.io.PRIVATE_DOC, (fs) => {
					console.log('è·å–æ–‡æ¡£ç›®å½•æ–‡ä»¶ç³»ç»ŸæˆåŠŸ')
					fs.root.getFile(fileName, {create: true}, (fileEntry) => {
						console.log('åˆ›å»ºæ–‡ä»¶æˆåŠŸ:', fileEntry.fullPath)
						fileEntry.createWriter((writer) => {
							console.log('åˆ›å»ºå†™å…¥å™¨æˆåŠŸ')
							
							writer.onwrite = (e) => {
								console.log('æ–‡ä»¶å†™å…¥å®Œæˆäº‹ä»¶:', e)
								console.log('å†™å…¥å™¨ä½ç½®:', writer.position)
								console.log('å†™å…¥å™¨é•¿åº¦:', writer.length)
								uni.showModal({
									title: 'å¯¼å‡ºæˆåŠŸ',
									content: `æ–‡ä»¶å·²ä¿å­˜åˆ°åº”ç”¨æ–‡æ¡£ç›®å½•ï¼š\n${fileName}\n\nå…±${recordCount}æ¡è®°å½•\næ–‡ä»¶å¤§å°ï¼š${writer.length}å­—èŠ‚`,
									showCancel: false,
									confirmText: 'çŸ¥é“äº†'
								})
							}
							
							writer.onerror = (err) => {
								console.error('å†™å…¥å¤±è´¥:', err)
								uni.showToast({
									title: 'æ–‡ä»¶å†™å…¥å¤±è´¥',
									icon: 'error'
								})
							}
							
							writer.onwriteend = () => {
								console.log('å†™å…¥ç»“æŸï¼Œæœ€ç»ˆæ–‡ä»¶å¤§å°:', writer.length)
							}
							
							// åˆ›å»ºå¸¦BOMçš„UTF-8 CSVå†…å®¹
							const bom = '\ufeff'
							const fullContent = bom + csvContent
							console.log('å®Œæ•´å†…å®¹é•¿åº¦(å«BOM):', fullContent.length)
							
							// å†™å…¥æ•°æ®
							console.log('å¼€å§‹å†™å…¥æ•°æ®...')
							writer.write(fullContent)
						}, (err) => {
							console.error('åˆ›å»ºå†™å…¥å™¨å¤±è´¥:', err)
							uni.showToast({
								title: 'åˆ›å»ºå†™å…¥å™¨å¤±è´¥',
								icon: 'error'
							})
						})
					}, (err) => {
						console.error('åˆ›å»ºæ–‡ä»¶å¤±è´¥:', err)
						uni.showToast({
							title: 'åˆ›å»ºæ–‡ä»¶å¤±è´¥',
							icon: 'error'
						})
					})
				}, (err) => {
					console.error('è·å–æ–‡æ¡£ç›®å½•å¤±è´¥:', err)
					uni.showToast({
						title: 'è·å–æ–‡æ¡£ç›®å½•å¤±è´¥',
						icon: 'error'
					})
				})
			},
			
			saveToCustomLocation(csvContent, recordCount, fileName) {
				uni.showModal({
					title: 'è‡ªå®šä¹‰ä¿å­˜è·¯å¾„',
					content: 'è¯·è¾“å…¥ä¿å­˜è·¯å¾„ï¼ˆä¸åŒ…å«æ–‡ä»¶åï¼‰ï¼š',
					editable: true,
					placeholderText: '/storage/emulated/0/Documents',
					success: (res) => {
						if (res.confirm && res.content && res.content.trim()) {
							const customPath = res.content.trim()
							this.saveToCustomPath(csvContent, recordCount, fileName, customPath)
						}
					}
				})
			},
			
			saveToCustomPath(csvContent, recordCount, fileName, customPath) {
				console.log('=== å¼€å§‹ä¿å­˜åˆ°è‡ªå®šä¹‰è·¯å¾„ ===')
				console.log('è‡ªå®šä¹‰è·¯å¾„:', customPath)
				console.log('æ–‡ä»¶å:', fileName)
				console.log('è®°å½•æ•°é‡:', recordCount)
				console.log('CSVå†…å®¹é•¿åº¦:', csvContent.length)
				console.log('CSVå†…å®¹é¢„è§ˆ:', csvContent.substring(0, 200))
				
				plus.io.resolveLocalFileSystemURL(customPath, (dirEntry) => {
					console.log('è§£æè‡ªå®šä¹‰è·¯å¾„æˆåŠŸ:', dirEntry.fullPath)
					dirEntry.getFile(fileName, {create: true}, (fileEntry) => {
						console.log('åˆ›å»ºæ–‡ä»¶æˆåŠŸ:', fileEntry.fullPath)
						fileEntry.createWriter((writer) => {
							console.log('åˆ›å»ºå†™å…¥å™¨æˆåŠŸ')
							
							writer.onwrite = (e) => {
								console.log('æ–‡ä»¶å†™å…¥å®Œæˆäº‹ä»¶:', e)
								console.log('å†™å…¥å™¨ä½ç½®:', writer.position)
								console.log('å†™å…¥å™¨é•¿åº¦:', writer.length)
								uni.showModal({
									title: 'å¯¼å‡ºæˆåŠŸ',
									content: `æ–‡ä»¶å·²ä¿å­˜åˆ°ï¼š\n${customPath}/${fileName}\n\nå…±${recordCount}æ¡è®°å½•\næ–‡ä»¶å¤§å°ï¼š${writer.length}å­—èŠ‚`,
									showCancel: false,
									confirmText: 'çŸ¥é“äº†'
								})
							}
							
							writer.onerror = (err) => {
								console.error('å†™å…¥å¤±è´¥:', err)
								uni.showToast({
									title: 'æ–‡ä»¶å†™å…¥å¤±è´¥',
									icon: 'error'
								})
							}
							
							writer.onwriteend = () => {
								console.log('å†™å…¥ç»“æŸï¼Œæœ€ç»ˆæ–‡ä»¶å¤§å°:', writer.length)
							}
							
							// åˆ›å»ºå¸¦BOMçš„UTF-8 CSVå†…å®¹
							const bom = '\ufeff'
							const fullContent = bom + csvContent
							console.log('å®Œæ•´å†…å®¹é•¿åº¦(å«BOM):', fullContent.length)
							
							// å†™å…¥æ•°æ®
							console.log('å¼€å§‹å†™å…¥æ•°æ®...')
							writer.write(fullContent)
						}, (err) => {
							console.error('åˆ›å»ºå†™å…¥å™¨å¤±è´¥:', err)
							uni.showToast({
								title: 'åˆ›å»ºå†™å…¥å™¨å¤±è´¥',
								icon: 'error'
							})
						})
					}, (err) => {
						console.error('åˆ›å»ºæ–‡ä»¶å¤±è´¥:', err)
						uni.showToast({
							title: 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„æƒé™',
							icon: 'none'
						})
					})
				}, (err) => {
					console.error('è·¯å¾„ä¸å­˜åœ¨:', err)
					uni.showToast({
						title: 'è·¯å¾„ä¸å­˜åœ¨æˆ–æ— æƒé™',
						icon: 'none'
					})
				})
			},
			
			saveFileWx(csvContent, recordCount, fileName) {
				// å¾®ä¿¡å°ç¨‹åºä¿å­˜æ–‡ä»¶
				const fs = wx.getFileSystemManager()
				const filePath = `${wx.env.USER_DATA_PATH}/${fileName}`
				
				fs.writeFile({
					filePath: filePath,
					data: csvContent,
					encoding: 'utf8',
					success: () => {
						uni.showActionSheet({
							itemList: ['åˆ†äº«æ–‡ä»¶', 'ä¿å­˜åˆ°ç›¸å†Œ', 'æ˜¾ç¤ºè·¯å¾„'],
							success: (res) => {
								if (res.tapIndex === 0) {
									this.shareFileWx(filePath, fileName, recordCount)
								} else if (res.tapIndex === 1) {
									this.saveToPhotosWx(csvContent, fileName, recordCount)
								} else if (res.tapIndex === 2) {
									uni.showModal({
										title: 'å¯¼å‡ºæˆåŠŸ',
										content: `æ–‡ä»¶å·²ä¿å­˜ï¼š\n${filePath}\n\nå…±${recordCount}æ¡è®°å½•`,
										showCancel: false,
										confirmText: 'çŸ¥é“äº†'
									})
								}
							}
						})
					},
					fail: (err) => {
						console.error('ä¿å­˜å¤±è´¥:', err)
						this.fallbackExport(csvContent, recordCount)
					}
				})
			},
			
			shareFileWx(filePath, fileName, recordCount) {
				wx.shareFileMessage({
					filePath: filePath,
					fileName: fileName,
					success: () => {
						uni.showToast({
							title: 'åˆ†äº«æˆåŠŸ',
							icon: 'success'
						})
					},
					fail: (err) => {
						console.error('åˆ†äº«å¤±è´¥:', err)
						uni.showModal({
							title: 'å¯¼å‡ºæˆåŠŸ',
							content: `æ–‡ä»¶å·²ä¿å­˜ï¼Œä½†åˆ†äº«å¤±è´¥\nè·¯å¾„ï¼š${filePath}\n\nå…±${recordCount}æ¡è®°å½•`,
							showCancel: false,
							confirmText: 'çŸ¥é“äº†'
						})
					}
				})
			},
			
			saveToPhotosWx(csvContent, fileName, recordCount) {
				// å°†CSVå†…å®¹è½¬æ¢ä¸ºå›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œï¼ˆä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼‰
				uni.showModal({
					title: 'æç¤º',
					content: 'å°ç¨‹åºæ— æ³•ç›´æ¥ä¿å­˜CSVæ–‡ä»¶åˆ°ç›¸å†Œï¼Œå»ºè®®ä½¿ç”¨åˆ†äº«åŠŸèƒ½æˆ–å¤åˆ¶åˆ°å‰ªè´´æ¿',
					showCancel: true,
					confirmText: 'å¤åˆ¶å†…å®¹',
					success: (res) => {
						if (res.confirm) {
							this.fallbackExport(csvContent, recordCount)
						}
					}
				})
			},
			
			downloadDataFile(csvContent, recordCount) {
				// ç”Ÿæˆæ–‡ä»¶åï¼ˆåŒ…å«å½“å‰æ—¥æœŸï¼‰
				const now = new Date()
				const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '')
				const fileName = `è®°è´¦æ•°æ®_${dateStr}.csv`
				
				// #ifdef H5
				// H5å¹³å°ä½¿ç”¨blobä¸‹è½½
				this.downloadFileH5(csvContent, fileName, recordCount)
				// #endif
				
				// #ifdef APP-PLUS
				// Appå¹³å°ä½¿ç”¨plus.io
				this.saveDataToFileApp(csvContent, recordCount, fileName)
				// #endif
				
				// #ifdef MP
				// å°ç¨‹åºå¹³å°å¤„ç†
				this.saveDataToFileMp(csvContent, recordCount, fileName)
				// #endif
				
				// #ifndef H5 || APP-PLUS || MP
				// å…¶ä»–å¹³å°é™çº§åˆ°å¤åˆ¶
				this.fallbackExport(csvContent, recordCount)
				// #endif
			},
			
			downloadFileH5(csvContent, fileName, recordCount) {
				try {
					// åˆ›å»ºBlobå¯¹è±¡
					const blob = new Blob(['\ufeff' + csvContent], { 
						type: 'text/csv;charset=utf-8' 
					})
					
					// åˆ›å»ºä¸‹è½½é“¾æ¥
					const url = window.URL.createObjectURL(blob)
					const link = document.createElement('a')
					link.href = url
					link.download = fileName
					link.style.display = 'none'
					
					// è§¦å‘ä¸‹è½½
					document.body.appendChild(link)
					link.click()
					
					// æ¸…ç†
					setTimeout(() => {
						document.body.removeChild(link)
						window.URL.revokeObjectURL(url)
					}, 100)
					
					uni.showToast({
						title: `æˆåŠŸå¯¼å‡º${recordCount}æ¡è®°å½•`,
						icon: 'success'
					})
				} catch (error) {
					console.error('ä¸‹è½½å¤±è´¥:', error)
					// é™çº§åˆ°å¤åˆ¶
					uni.setClipboardData({
						data: csvContent,
						success: () => {
							uni.showToast({
								title: 'ä¸‹è½½å¤±è´¥ï¼Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
								icon: 'success'
							})
						}
					})
				}
			},
			
			saveDataToFile(csvContent, recordCount, fileName) {
				try {
					// è·å–æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨
					const fs = uni.getFileSystemManager()
					
					// å†™å…¥ä¸´æ—¶æ–‡ä»¶
					const tempPath = `${uni.env.USER_DATA_PATH}/${fileName}`
					
					fs.writeFileSync(tempPath, csvContent, 'utf8')
					
					// ä¿å­˜æˆåŠŸåçš„æ“ä½œé€‰æ‹©
					uni.showActionSheet({
						itemList: ['åˆ†äº«æ–‡ä»¶', 'æ˜¾ç¤ºæ–‡ä»¶ä½ç½®'],
						success: (res) => {
							if (res.tapIndex === 0) {
								// åˆ†äº«æ–‡ä»¶
								this.shareFile(tempPath, fileName, recordCount)
							} else if (res.tapIndex === 1) {
								// æ˜¾ç¤ºæ–‡ä»¶ä½ç½®
								uni.showModal({
									title: 'å¯¼å‡ºæˆåŠŸ',
									content: `æ–‡ä»¶å·²ä¿å­˜è‡³ï¼š\n${tempPath}\n\nå…±${recordCount}æ¡è®°å½•`,
									showCancel: false,
									confirmText: 'çŸ¥é“äº†'
								})
							}
						}
					})
				} catch (error) {
					console.error('æ–‡ä»¶å†™å…¥å¤±è´¥:', error)
					// é™çº§åˆ°å¤åˆ¶
					uni.setClipboardData({
						data: csvContent,
						success: () => {
							uni.showToast({
								title: 'æ–‡ä»¶ä¿å­˜å¤±è´¥ï¼Œå·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
								icon: 'success'
							})
						}
					})
				}
			},
			
			saveDataToFileApp(csvContent, recordCount, fileName) {
				// Appå¹³å°ä½¿ç”¨plus.io
				if (typeof plus !== 'undefined') {
					plus.io.requestFileSystem(plus.io.PUBLIC_DOWNLOADS, (fs) => {
						fs.root.getFile(fileName, {create: true}, (fileEntry) => {
							fileEntry.createWriter((writer) => {
								writer.onwrite = () => {
									uni.showModal({
										title: 'å¯¼å‡ºæˆåŠŸ',
										content: `æ–‡ä»¶å·²ä¿å­˜åˆ°ä¸‹è½½ç›®å½•ï¼š\n${fileName}\n\nå…±${recordCount}æ¡è®°å½•`,
										showCancel: false,
										confirmText: 'çŸ¥é“äº†'
									})
								}
								writer.onerror = (err) => {
									console.error('å†™å…¥å¤±è´¥:', err)
									this.fallbackExport(csvContent, recordCount)
								}
								writer.write(new Blob(['\ufeff' + csvContent], {type: 'text/csv'}))
							})
						}, (err) => {
							console.error('åˆ›å»ºæ–‡ä»¶å¤±è´¥:', err)
							this.fallbackExport(csvContent, recordCount)
						})
					}, (err) => {
						console.error('è·å–æ–‡ä»¶ç³»ç»Ÿå¤±è´¥:', err)
						this.fallbackExport(csvContent, recordCount)
					})
				} else {
					this.fallbackExport(csvContent, recordCount)
				}
			},
			
			saveDataToFileMp(csvContent, recordCount, fileName) {
				// å°ç¨‹åºå¹³å°åªèƒ½å¤åˆ¶åˆ°å‰ªè´´æ¿
				this.fallbackExport(csvContent, recordCount)
			},
			
			fallbackExport(csvContent, recordCount) {
				// é™çº§åˆ°å¤åˆ¶å‰ªè´´æ¿
				uni.setClipboardData({
					data: csvContent,
					success: () => {
						uni.showModal({
							title: 'å¯¼å‡ºæˆåŠŸ',
							content: `ç”±äºå¹³å°é™åˆ¶ï¼Œæ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿\n\nå…±${recordCount}æ¡è®°å½•\n\næ‚¨å¯ä»¥ç²˜è´´åˆ°ä»»æ„æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ä¿å­˜ä¸ºCSVæ–‡ä»¶`,
							showCancel: false,
							confirmText: 'çŸ¥é“äº†'
						})
					},
					fail: () => {
						uni.showToast({
							title: 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•',
							icon: 'none'
						})
					}
				})
			},
			
			shareFile(filePath, fileName, recordCount) {
				// ä½¿ç”¨ç³»ç»Ÿåˆ†äº«åŠŸèƒ½
				if (typeof plus !== 'undefined' && plus.share) {
					// Appå¹³å°åˆ†äº«
					plus.share.sendWithSystem({
						type: 'file',
						path: filePath,
						success: () => {
							uni.showToast({
								title: 'å¯¼å‡ºæˆåŠŸ',
								icon: 'success'
							})
						},
						fail: (err) => {
							console.error('åˆ†äº«å¤±è´¥:', err)
							// é™çº§åˆ°æ˜¾ç¤ºæ–‡ä»¶è·¯å¾„
							uni.showModal({
								title: 'å¯¼å‡ºæˆåŠŸ',
								content: `æ–‡ä»¶å·²ä¿å­˜è‡³ï¼š\n${filePath}\n\nå…±${recordCount}æ¡è®°å½•`,
								showCancel: false,
								confirmText: 'çŸ¥é“äº†'
							})
						}
					})
				} else {
					// å…¶ä»–å¹³å°é™çº§å¤„ç†
					uni.showModal({
						title: 'å¯¼å‡ºæˆåŠŸ',
						content: `æ–‡ä»¶å·²ä¿å­˜è‡³ï¼š\n${filePath}\n\nå…±${recordCount}æ¡è®°å½•`,
						showCancel: false,
						confirmText: 'çŸ¥é“äº†'
					})
				}
			}
		}
	}
</script>

<style>
	.container {
		background-color: #f5f5f5;
		min-height: 100vh;
		padding: 0;
	}
	
	/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
	.user-info {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		padding: 40rpx 30rpx 60rpx;
		position: relative;
		border-radius: 0 0 40rpx 40rpx;
	}
	
	.avatar-section {
		display: flex;
		flex-direction: column;
		align-items: center;
		color: white;
	}
	
	.avatar {
		width: 120rpx;
		height: 120rpx;
		border-radius: 60rpx;
		border: 4rpx solid rgba(255, 255, 255, 0.3);
		margin-bottom: 20rpx;
	}
	
	.username {
		font-size: 36rpx;
		font-weight: bold;
		margin-bottom: 10rpx;
	}
	
	.user-desc {
		font-size: 28rpx;
		opacity: 0.8;
	}
	
	/* æ•°æ®ç®¡ç†åŒºåŸŸ */
	.data-management {
		background: white;
		margin: 30rpx 30rpx 40rpx;
		border-radius: 20rpx;
		overflow: hidden;
		box-shadow: 0 2rpx 20rpx rgba(0, 0, 0, 0.08);
	}
	
	.management-title {
		display: block;
		font-size: 32rpx;
		font-weight: bold;
		color: #333;
		padding: 30rpx 30rpx 20rpx;
		border-bottom: 1rpx solid #f0f0f0;
	}
	
	.management-item {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 30rpx;
		border-bottom: 1rpx solid #f8f8f8;
		transition: background-color 0.2s;
	}
	
	.management-item:last-child {
		border-bottom: none;
	}
	
	.management-item:active {
		background-color: #f8f8f8;
	}
	
	.management-left {
		display: flex;
		align-items: center;
	}
	
	.management-icon {
		font-size: 36rpx;
		margin-right: 20rpx;
		width: 50rpx;
		text-align: center;
	}
	
	.management-text {
		font-size: 30rpx;
		color: #333;
	}
	
	.management-arrow {
		font-size: 28rpx;
		color: #999;
	}
	
	/* ç‰¹æ®Šé¡¹ç›®æ ·å¼ */
	.ai-chat-item .management-icon {
		background: linear-gradient(45deg, #FF6B6B, #FF8E53);
		border-radius: 50%;
		color: white;
		line-height: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 50rpx;
		height: 50rpx;
	}
	
	.ai-config-item .management-icon {
		background: linear-gradient(45deg, #4ECDC4, #44A08D);
		border-radius: 50%;
		color: white;
		line-height: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 50rpx;
		height: 50rpx;
	}
	
	.danger-item .management-text {
		color: #ff4d4f;
	}
	
	.danger-item .management-icon {
		color: #ff4d4f;
	}
	
	/* åº”ç”¨ä¿¡æ¯åŒºåŸŸ */
	.app-info {
		background: white;
		margin: 0 30rpx 40rpx;
		border-radius: 20rpx;
		overflow: hidden;
		box-shadow: 0 2rpx 20rpx rgba(0, 0, 0, 0.08);
	}
	
	.info-title {
		display: block;
		font-size: 32rpx;
		font-weight: bold;
		color: #333;
		padding: 30rpx 30rpx 20rpx;
		border-bottom: 1rpx solid #f0f0f0;
	}
	
	.info-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 25rpx 30rpx;
		border-bottom: 1rpx solid #f8f8f8;
	}
	
	.info-item:last-child {
		border-bottom: none;
	}
	
	.info-label {
		font-size: 28rpx;
		color: #666;
	}
	
	.info-value {
		font-size: 28rpx;
		color: #333;
		font-weight: 500;
	}
	
	/* å“åº”å¼é€‚é… */
	@media (max-width: 750rpx) {
		.container {
			padding: 0;
		}
		
		.data-management,
		.app-info {
			margin-left: 20rpx;
			margin-right: 20rpx;
		}
	}
</style>
